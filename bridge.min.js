if("undefined"==typeof jQuery)throw new Error("jQuery is not loaded. jQuery is required for Bridge Javascript Library to work.");if("undefined"==typeof _)throw new Error("Lodash is not loaded. Lodash is required for Bridge Javascript Library to work.");var Bridge={directions:{n:{name:"North",lho:"e",rho:"w",cho:"s",index:1,html:"north"},e:{name:"East",lho:"s",rho:"n",cho:"w",index:2,html:"east"},s:{name:"South",lho:"w",rho:"e",cho:"n",index:3,html:"south"},w:{name:"West",lho:"n",rho:"s",cho:"e",index:0,html:"west"}},directionOrder:[],suits:{s:{name:"Spades",index:0,text:"spades",html:"&spades;"},h:{name:"Hearts",index:1,text:"hearts",html:"&hearts;"},d:{name:"Diamonds",index:2,text:"diamonds",html:"&diams;"},c:{name:"Clubs",index:3,text:"clubs",html:"&clubs;"}},suitOrder:[],calls:{n:{name:"No Trump",index:0,isStrain:!0,bid:!0,text:"notrump",html:"nt"},s:{name:"Spades",index:1,isStrain:!0,bid:!0,text:"spades",html:"&spades;"},h:{name:"Hearts",index:2,isStrain:!0,bid:!0,text:"hearts",html:"&hearts;"},d:{name:"Diamonds",index:3,isStrain:!0,bid:!0,text:"diamonds",html:"&diams;"},c:{name:"Clubs",index:4,isStrain:!0,bid:!0,text:"clubs",html:"&clubs;"},p:{name:"Pass",index:5,isStrain:!1,bid:!1,text:"pass",html:"p"},x:{name:"Double",index:6,isStrain:!1,bid:!1,text:"double",html:"x"},r:{name:"Redouble",index:7,isStrain:!1,bid:!1,text:"redouble",html:"xx"}},callOrder:[],ranks:{a:{name:"Ace",index:0,html:"a"},k:{name:"King",index:1,html:"k"},q:{name:"Queen",index:2,html:"q"},j:{name:"Jack",index:3,html:"j"},t:{name:"Ten",index:4,html:"t"},9:{name:"Nine",index:5,html:"9"},8:{name:"Eight",index:6,html:"8"},7:{name:"Seven",index:7,html:"7"},6:{name:"Six",index:8,html:"6"},5:{name:"Five",index:9,html:"5"},4:{name:"Four",index:10,html:"4"},3:{name:"Three",index:11,html:"3"},2:{name:"Two",index:12,html:"2"}},rankOrder:[],vulnerabilities:{"-":{name:"None",index:0,html:"None"},n:{name:"NS",index:0,html:"North-South"},e:{name:"EW",index:0,html:"East-West"},b:{name:"Both",index:0,html:"Both"}}};Bridge._addKey=function(e){for(var t in e)e[t].key=t},Bridge._createIndexArray=function(e){var t=[];for(var r in e)t[e[r].index]=r;return t},Bridge._checkListMembership=function(e,t,r,i){if(!_.has(t,e)){var n=e+" is not a valid "+r;Bridge._reportError(n,i)}},Bridge._belongsTo=function(e,t){return _.has(t,e)},Bridge._checkRequiredArgument=function(e,t,r){e||""===e||Bridge._reportError("Required argument "+t+" has not been specified",r)},Bridge._addKey(Bridge.directions),Bridge._addKey(Bridge.suits),Bridge._addKey(Bridge.calls),Bridge._addKey(Bridge.ranks),Bridge._addKey(Bridge.vulnerabilities),Bridge.directionOrder=Bridge._createIndexArray(Bridge.directions),Bridge.suitOrder=Bridge._createIndexArray(Bridge.suits),Bridge.callOrder=Bridge._createIndexArray(Bridge.calls),Bridge.rankOrder=Bridge._createIndexArray(Bridge.ranks),Bridge.enums={directions:{NORTH:"n",SOUTH:"s",EAST:"e",WEST:"w"},suits:{SPADES:"s",SPADE:"s",HEARTS:"h",HEART:"h",DIAMONDS:"d",DIAMOND:"d",CLUBS:"c",CLUB:"c"}},Bridge.options={useContextInErrorMessage:!1,log:{EVENT:{name:"events",enabled:!0},DEBUG:{name:"debug",enabled:!1}},raiseEvents:!0},Bridge.enableAllEventTriggers=function(){Bridge.options.raiseEvents=!0},Bridge.disableAllEventTriggers=function(){Bridge.options.raiseEvents=!1},Bridge.CONSTANTS={eventNameDelimiter:":",changedEventName:"changed",changeEventName:"change"},Bridge.getEventName=function(e){return e.join(Bridge.CONSTANTS.eventNameDelimiter)},Bridge._raiseEvents=function(e,t,r){if(Bridge.options.raiseEvents&&e.raiseEvents){var i=Bridge.CONSTANTS.eventNameDelimiter,n=e.id+i+Bridge.CONSTANTS.changedEventName;$(document).trigger(n,{raisedBy:e,action:t,parameters:r}),Bridge._logEvent(n+" - "+t)}},Bridge._triggerOneEvent=function(e,t,r,i){var n=Bridge.CONSTANTS.eventNameDelimiter;$(document).trigger(e,{raisedBy:t,action:r,parameters:i}),Bridge._logEvent(e+" - "+r),e=t.id+n+e,$(document).trigger(e,{raisedBy:t,action:r,parameters:i}),Bridge._logEvent(e+" - "+r)},Bridge._log=function(e,t){if(!t||t.enabled){if("string"===$.type(t))var r=t;else var r=t.name||"unknown";console&&console.log(r+" : "+e)}},Bridge._logEvent=function(e){Bridge._log(e,Bridge.options.log.EVENT)},Bridge._logDebug=function(e){Bridge._log(e,Bridge.options.log.DEBUG)},Bridge.isHigherRank=function(e,t){return Bridge.ranks[e].index<Bridge.ranks[t].index},Bridge.isNorthSouth=function(e){return"n"===e||"s"===e},Bridge.isEastWest=function(e){return"e"===e||"w"===e},Bridge.getLHO=function(e){return Bridge.directions[e].lho},Bridge.getRHO=function(e){return Bridge.directions[e].rho},Bridge.getPartner=function(e){return Bridge.directions[e].cho},Bridge.areOpponents=function(e,t){return Bridge.getLHO(e)===t||Bridge.getRHO(e)===t},Bridge.arePartners=function(e,t){return Bridge.getPartner(e)===t},Bridge.makeIdentifier=function(e){return e.trim().replace(/[^a-zA-Z0-9]+/g,"_")},Bridge.assignDefault=function(e,t){return"undefined"==typeof e?t:e},Bridge.getHash=function(e){return Bridge._getParameters(location.hash,"#",e)},Bridge.getQuery=function(e){return Bridge._getQuery(document.URL,e)},Bridge._getQuery=function(e,t){return Bridge._getParameters(e,"?",t)},Bridge._generateID=function(e){if(e&&e.id)return e.id;var t=(new Date).getTime(),r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?r:3&r|8).toString(16)});return r},Bridge._getParameters=function(e,t,r){var i=e.split(t);if(i.length<2)return{};var n=i[1];return r&&(n=n.split(r)[0]),Bridge._parseParameterValues(n,"&","=")},Bridge._parseParameterValues=function(e,t,r){t=Bridge.assignDefault(t,"&"),r=Bridge.assignDefault(r,"=");var i={};if(e=e.trim(),!e)return i;for(var n=e.split(t),a=0;a<n.length;++a){var o=n[a].split(r);o.length<2?i[o]=!0:i[o[0]]=o[1]}return i},Bridge._parseContainedText=function(e,t,r,i){var n={};return n.position=e.indexOf(r,t),n.position===-1&&Bridge._reportError("Ending delimiter "+r+" not found in "+e,i),n.text=e.slice(t+1,n.position),n},Bridge._reportError=function(e,t){if(!Bridge.options.useContextInErrorMessage)throw new Error(e);throw new Error((t?t+" - ":"")+e)},Bridge._checkDirection=function(e,t){Bridge._checkListMembership(e,Bridge.directions,"Direction",t)},Bridge.isDirection=function(e){return Bridge._belongsTo(e,Bridge.directions)},Bridge._checkSuit=function(e,t){Bridge._checkListMembership(e,Bridge.suits,"Suit",t)},Bridge.isSuit=function(e){return Bridge._belongsTo(e,Bridge.suits)},Bridge._checkStrain=function(e,t){Bridge._checkListMembership(e,Bridge.calls,"Strain",t),Bridge.calls[e].isStrain||Bridge._reportError("Strain "+e+" is not a valid strain!",t)},Bridge.isStrain=function(e){return _.has(Bridge.calls,e)&&Bridge.calls[e].isStrain},Bridge._checkCard=function(e,t){e&&2===e.length||Bridge._reportError("Card "+e+" does not have length 2",t);var r=e[0];Bridge._checkSuit(r,t);var i=e[1];Bridge._checkRank(i,t)},Bridge.isCard=function(e){if(!e||2!==e.length)return!1;var t=e[0],r=e[1];return Bridge.isSuit(t)&&Bridge.isRank(r)},Bridge._checkCall=function(e,t){Bridge._checkListMembership(e,Bridge.calls,"Call",t)},Bridge.isCall=function(e){return Bridge._belongsTo(e,Bridge.calls)},Bridge._checkLevel=function(e,t){var r=parseInt(e);(isNaN(r)||String(r)!==String(e)||r<1||r>7)&&Bridge._reportError(e+" is not a valid level",t)},Bridge.isLevel=function(e){var t=parseInt(e);return!(isNaN(t)||String(t)!==String(e)||t<1||t>7)},Bridge._checkBid=function(e,t){if((e.length<1||e.length>2)&&Bridge._reportError("Bid "+e+" does not have length 1 or 2",t),1===e.length){var r=e[0];return Bridge._checkCall(r,t),void(Bridge.isStrain(r)&&Bridge._reportError("Invalid bid "+e,t))}var i=e[0],r=e[1];Bridge._checkCall(r,t),Bridge.isStrain(r)||Bridge._reportError("Invalid bid "+e,t),Bridge._checkLevel(i,t)},Bridge.isBid=function(e){if(e.length<1||e.length>2)return!1;if(1===e.length){var t=e[0];return Bridge.isCall(t)&&!Bridge.isStrain(t)}var r=e[0],t=e[1];return Bridge.isLevel(r)&&Bridge.isCall(t)&&Bridge.isStrain(t)},Bridge._checkRank=function(e,t){Bridge._checkListMembership(e,Bridge.ranks,"Rank",t)},Bridge.isRank=function(e){return Bridge._belongsTo(e,Bridge.ranks)},Bridge._checkVulnerability=function(e,t){Bridge._checkListMembership(e,Bridge.vulnerabilities,"Vulnerability",t)},Bridge.isVulnerability=function(e){return Bridge._belongsTo(e,Bridge.vulnerabilities)},Bridge._checkIndex=function(e,t,r){t>=e.length&&Bridge._reportError("array does not have item at index "+t,r)},Bridge.IDManager={usedIDs:{}},Bridge.IDManager.getID=function(e){if(!e){var t=new Date,r=t.toJSON();e=Bridge.makeIdentifier(r);for(var i=1;e in Bridge.IDManager.usedIDs;)e=r+"-"+i;return e}var n="In Bridge.IDManager.getID";return e in Bridge.IDManager.usedIDs&&Bridge._reportError(e+" is an already existing ID.",n),e};var Bridge=Bridge||{};Bridge.Deal=function(e){this.id=Bridge.IDManager.getID(e),this.type="Deal",this.raiseEvents=!0,this.respondToEvents=!0,this.cards={};for(var t in Bridge.suits){this.cards[t]={};for(var r in Bridge.ranks)this.cards[t][r]=new Bridge.Card(t,r)}this.hands={};for(var i in Bridge.directions)this.hands[i]=new Bridge.Hand(i,this);this._activeHand="n",this.board=1,this.vulnerability="-",this.dealer="n",this.getHand("n").makeActive(),this.scoring="KO",this.notes="",this.auction=new Bridge.Auction(this),this.play=new Bridge.Play(this),this.raiseEvents=!0,this.onChanged()},Bridge.Deal.prototype.getHand=function(e){return Bridge._checkDirection(e),this.hands[e]},Bridge.Deal.prototype.getActiveHand=function(){return this._activeHand},Bridge.Deal.prototype.setActiveHand=function(e){_.isObject(e)&&(e=e.direction),Bridge._checkDirection(e),this.getHand(this.getActiveHand()).makeInactive(),this._activeHand=e,this.getHand(e).makeActive(),this.onChange("setActiveHand",e)},Bridge.Deal.prototype.getBoard=function(){return this.board},Bridge.Deal.prototype.setBoard=function(e){var t=parseInt(e);(isNaN(t)||String(t)!==String(e)||t<1)&&Bridge._reportError(e+" is not a valid board number","In setBoard"),this.board=t,this.onChange("setBoard",this.board)},Bridge.Deal.prototype.getDealer=function(){return this.dealer},Bridge.Deal.prototype.setDealer=function(e){e=e.toLowerCase(),Bridge._checkDirection(e),this.dealer=e,this.getAuction().setDealer(e),this.onChange("setDealer",e)},Bridge.Deal.prototype.getVulnerability=function(){return this.vulnerability},Bridge.Deal.prototype.setVulnerability=function(e){e=e.toLowerCase(),"0"===e&&(e="-"),Bridge._checkVulnerability(e),this.vulnerability=e,this.getAuction().setVulnerability(e),this.onChange("setVulnerability",e)},Bridge.Deal.prototype.getScoring=function(){return this.scoring},Bridge.Deal.prototype.setScoring=function(e){Bridge._checkRequiredArgument(e),this.scoring=e,this.onChange("setScoring",e)},Bridge.Deal.prototype.setID=function(e){Bridge._checkRequiredArgument(e),this.id=e},Bridge.Deal.prototype.getID=function(){return this.id},Bridge.Deal.prototype.getNotes=function(){return this.notes},Bridge.Deal.prototype.setNotes=function(e){Bridge._checkRequiredArgument(e),this.notes=e,this.onChange("setNotes",e)},Bridge.Deal.prototype.getAuction=function(){return this.auction},Bridge.Deal.prototype.getPlay=function(){return this.play},Bridge.Deal.prototype.addCard=function(e){this.getHand(e.direction).addCard(e.suit,e.rank)},Bridge.Deal.prototype.removeCard=function(e){this.getHand(e.direction).removeCard(e.suit,e.rank)},Bridge.Deal.prototype.set=function(e,t){var r="In Bridge.Deal.prototype.set";switch(Bridge._checkRequiredArgument(e,"Property",r),Bridge._checkRequiredArgument(t,"Value for Property "+e,r),e){case"board":this.setBoard(t);break;case"vulnerability":this.setVulnerability(t);break;case"dealer":this.setDealer(t);break;case"scoring":this.setScoring(t);break;case"notes":this.setNotes(t);break;case"id":this.setID(t);default:Bridge._reportError("Unknown deal property "+e,r)}},Bridge.Deal.prototype.get=function(e){var t="In Bridge.Deal.prototype.get - ";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"board":return this.getBoard();case"vulnerability":return this.getVulnerability();case"dealer":return this.getDealer();case"scoring":return this.getScoring();case"notes":return this.getNotes();case"auction":return this.getAuction();case"play":return this.getPlay();case"id":return this.getID();default:Bridge._reportError("Unknown deal property "+e,t)}},Bridge.Deal.prototype.assignRest=function(){var e=[];for(var t in Bridge.suits)for(var r in Bridge.ranks)this.cards[t][r].isAssigned()||e.push(t+r);if(!_.isEmpty(e)){e=_.shuffle(e);var i="n",n=null;_.each(e,function(e){for(;13===this.getHand(i).getCount();)n||(n=i),i=Bridge.getLHO(i),n===i&&Bridge._reportError("Unable to assign remaining cards");this.getHand(i).addCard(e[0],e[1])},this),this.onChange("assignRest",e)}},Bridge.Deal.prototype.fromString=function(e){var t={};_.each(e.split("&"),function(e){var r=e.split("=");t[r[0]]=decodeURIComponent(r[1])});var r=0;_.each(t,function(e,t){switch(t){case"b":this.set("board",e);break;case"d":this.set("dealer",e);break;case"v":this.set("vulnerability",e);break;case"t":this.set("notes",e);break;case"a":var i=this.getAuction();"-"===e[0]?i.setContract(e.slice(1)):i.setAuction(e);break;case"p":this.getPlay().fromString(e);break;case"n":case"e":case"s":case"w":var n=this.getHand(t);n.setHand(e),13===n.getCount()&&r++;break;case"nn":case"en":case"sn":case"wn":var n=this.getHand(t[0]);n.setName(e)}},this),3===r&&this.assignRest(),this.getPlay().initialize(),_.each(t,function(e,t){switch(t){case"p":this.getPlay().fromString(e)}},this),this.onChange("setDeal",e)},Bridge.Deal.prototype.toString=function(e){e=Bridge.assignDefault(e,!1);var t=[];this.board&&t.push("b="+this.getBoard()),this.dealer&&t.push("d="+this.getDealer()),this.vulnerability&&t.push("v="+this.getVulnerability()),e&&this.notes&&t.push("t="+this.getNotes());for(var r in Bridge.directions){var i=this.getHand(r);i.toString();i&&t.push(r+"="+i),t.push(r+"n="+i.getName())}var n=this.getAuction().toString();n&&t.push("a="+n);var a=this.getPlay().toString();return a&&t.push("p="+a),t.join("&")},Bridge.Deal.prototype.toJSON=function(){var e={};e.version="1.0";var t=["board","dealer","vulnerability","scoring","notes"];_.each(t,function(t){e[t]=this.get(t)},this),e.hands={};for(var r in Bridge.directions){var i=this.getHand(r);e.hands[r]=i.toJSON()}return e.auction=this.getAuction().toJSON(),e.play=this.getPlay().toJSON(),e},Bridge.Deal.prototype.fromJSON=function(e){var t=["board","dealer","vulnerability","scoring","notes"];if(_.each(t,function(t){_.has(e,t)&&this.set(t,e[t])},this),_.has(e,"hands"))for(var r in Bridge.directions)if(_.has(e.hands,r)){var i=this.getHand(r);i.fromJSON(e.hands[r])}_.has(e,"auction")&&this.getAuction().fromJSON(e.auction),this.getPlay().initialize(),_.has(e,"play")&&this.getPlay().fromJSON(e.play),this.onChange("setDeal",this.toString())},Bridge.Deal.prototype.fromLIN=function(e){for(var t="In Bridge.Deal.fromLin - ",r=e.split("|"),i=["s","w","n","e"],n=0;n<r.length;++n)switch(_.startsWith(r[n].toLowerCase(),"board")&&this.setBoard(r[n].trim().slice(5).trim()),r[n].toLowerCase()){case"pn":Bridge._checkIndex(r,n+1,t+"processing pn - ");for(var a=r[n+1].split(","),o=0;o<i.length;++o)if(o<a.length){var s=i[o],d=a[o];_.startsWith(d,"~~")&&(d="Robot"),this.getHand(s).setName(d)}break;case"md":Bridge._checkIndex(r,n+1,t+"processing md - ");var c=r[n+1].split(","),l={1:"s",2:"w",3:"n",4:"e"},g=l[c[0][0]];this.setDealer(g);var h=c[0].slice(1),s="s";this.getHand(s).setHand(h);for(var o=1;o<c.length;++o){var s=Bridge.getLHO(s),h=c[o];this.getHand(s).setHand(h)}this.assignRest();break;case"mb":Bridge._checkIndex(r,n+1,t+"processing mb - ");var u=r[n+1].split("!")[0].slice(0,2).toLowerCase();"d"===u&&(u="x");var p=null;if(n+2<r.length&&"an"===r[n+2].toLowerCase()){var p=r[n+3];p=p.replace("(",""),p=p.replace(")","")}this.getAuction().addCall(u,null,p);break;case"sv":Bridge._checkIndex(r,n+1,t+"processing sv - ");var B=r[n+1];"o"===B&&(B="-"),this.setVulnerability(B)}this.getPlay().initialize();for(var n=0;n<r.length;++n)switch(_.startsWith(r[n].toLowerCase(),"board")&&this.setBoard(r[n].trim().slice(5).trim()),r[n].toLowerCase()){case"pc":Bridge._checkIndex(r,n+1,t+"processing pc - ");var y=r[n+1].slice(0,2);this.getPlay().addCard(y[0],y[1])}this.onChange("setDeal",this.toString())},Bridge.Deal.prototype.onChanged=function(){if(this.respondToEvents){var e=Bridge.getEventName([this.getID(),Bridge.CONSTANTS.changeEventName,"deal"]);$(document).on(e,{deal:this},function(e,t){e.data.deal[t.operation](t.parameters)})}},Bridge.Deal.prototype.onChange=function(e,t){Bridge._raiseEvents(this,e,t)};var Bridge=Bridge||{};Bridge.Card=function(e,t){Bridge._checkSuit(e),this.suit=e,Bridge._checkRank(t),this.rank=t,this.direction=null,this.played=!1},Bridge.Card.prototype.getSuit=function(){return this.suit},Bridge.Card.prototype.getRank=function(){return this.rank},Bridge.Card.prototype.getDirection=function(){return this.direction},Bridge.Card.prototype.setDirection=function(e){Bridge._checkDirection(e),this.direction=e},Bridge.Card.prototype.assign=function(e){this.setDirection(e)},Bridge.Card.prototype.unAssign=function(){this.direction=null},Bridge.Card.prototype.isAssigned=function(){return null!==this.direction},Bridge.Card.prototype.play=function(e){var t="In Card.play";this.direction||Bridge._reportError("Cannot play card : "+this.getSuit()+this.getRank()+" since it is not assigned to any direction",t),e!==this.direction&&Bridge._reportError("Cannot play card : "+this.getSuit()+this.getRank()+" since it is does not belong to "+e,t),this.played&&Bridge._reportError("Cannot play card : "+this.getSuit()+this.getRank()+" since it is already played",t),this.played=!0},Bridge.Card.prototype.get=function(e){var t="In Card.get";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"suit":return this.getSuit();case"rank":return this.getRank();case"direction":return this.getDirection();default:Bridge._reportError("Unknown property "+e,t)}},Bridge.Card.prototype.set=function(e,t){var r="In Card.set";switch(Bridge._checkRequiredArgument(e,"Property",r),Bridge._checkRequiredArgument(t,"Value for Property "+e,r),e){case"direction":return this.setDirection(t);default:Bridge._reportError("Unknown property "+e,r)}},Bridge.Card.prototype.toString=function(){return this.suit+this.rank};var Bridge=Bridge||{};Bridge.Hand=function(e,t){Bridge._checkDirection(e),this.deal=t,this.parent=t,this.id=t?t.id:Bridge.IDManager.getID(),this.type="Hand",this.raiseEvents=!0,this.respondToEvents=!0,this.direction=e,this.name=Bridge.directions[e].name,this.cards={};for(var r in Bridge.suits){this.cards[r]={};for(var i in Bridge.ranks)this.cards[r][i]=!1}this.showAsX={};for(var r in Bridge.suits){this.showAsX[r]={};for(var i in Bridge.ranks)this.showAsX[r][i]=!1}this.numCards={all:0};for(var r in Bridge.suits)this.numCards[r]=0;this._isActive=!1,this.onChanged()},Bridge.Hand.prototype.setActiveHand=function(){this.deal&&this.deal.setActiveHand(this.getDirection())},Bridge.Hand.prototype.makeActive=function(){this._isActive=!0,this.onChange("makeActive")},Bridge.Hand.prototype.makeInactive=function(){this._isActive=!1,this.onChange("makeInactive")},Bridge.Hand.prototype.getDirection=function(){return this.direction},Bridge.Hand.prototype.setName=function(e){_.isObject(e)&&(e=e.name),Bridge._checkRequiredArgument(e),this.name=e,this.onChange("setName",e)},Bridge.Hand.prototype.getName=function(){return this.name},Bridge.Hand.prototype.getCount=function(e){return e?(Bridge._checkSuit(e),this.numCards[e]):this.numCards.all},Bridge.Hand.prototype.setHand=function(e){_.isObject(e)&&(e=e.hand),Bridge._checkRequiredArgument(e),this.fromString(e)},Bridge.Hand.prototype.getHand=function(){return this.toString()},Bridge.Hand.prototype.getID=function(){return this.id},Bridge.Hand.prototype.isActive=function(){return this._isActive},Bridge.Hand.prototype.getCards=function(e){Bridge._checkSuit(e);var t="";return _.each(Bridge.rankOrder,function(r){this.cards[e][r]&&(t+=this.showAsX[e][r]?"x":r)},this),t},Bridge.Hand.prototype.addCard=function(e,t){_.isObject(e)&&(t=e.rank,e=e.suit);var r="In addCard";Bridge._checkSuit(e,r);var i=!1;if("string"==typeof t&&"x"===t.toLowerCase())for(var n=Bridge.rankOrder.length-1;n>=0;--n){var a=Bridge.rankOrder[n];if(this.deal){var o=this.deal.cards[e][a];o.isAssigned()||(t=a,i=!0,n=-1)}else this.cards[e][a]||(t=a,i=!0,n=-1)}if(Bridge._checkRank(t,r),13===this.getCount()&&Bridge._reportError(this.name+"'s Hand : already has 13 cards. Cannot add "+e+t,r),this.cards[e][t]&&Bridge._reportError(e+t+" is already assigned to "+this.direction+". Cannot add again",r),this.deal){var o=this.deal.cards[e][t];o.isAssigned()&&Bridge._reportError(e+t+" is already assigned to "+o.getDirection()+". Cannot add again",r)}this.cards[e][t]=!0,this.showAsX[e][t]=i,this.deal&&this.deal.cards[e][t].assign(this.direction),this.numCards.all++,this.numCards[e]++,this.onChange("addCard",{suit:e,rank:t})},Bridge.Hand.prototype.removeCard=function(e,t){_.isObject(e)&&(t=e.rank,e=e.suit);var r="In removeCard";if(Bridge._checkSuit(e,r),Bridge._checkRank(t,r),this.deal){var i=this.deal.cards[e][t];i.isAssigned()||Bridge._reportError(e+t+" is not assigned to "+this.direction+". Cannot remove",r)}this.cards[e][t]||Bridge._reportError(e+t+" is not assigned to "+this.direction+". Cannot remove",r),this.cards[e][t]=!1,this.numCards.all--,this.numCards[e]--,this.deal&&this.deal.cards[e][t].unAssign(),this.onChange("removeCard",{suit:e,rank:t})},Bridge.Hand.prototype.hasCard=function(e,t){var r="In hasCard";return Bridge._checkSuit(e,r),Bridge._checkRank(t,r),this.cards[e][t]},Bridge.Hand.prototype.clearCards=function(){for(var e in Bridge.suits)for(var t in Bridge.ranks)this.cards[e][t]&&this.removeCard(e,t)},Bridge.Hand.prototype.set=function(e,t){var r="In Hand.set";switch(Bridge._checkRequiredArgument(e,"Property",r),Bridge._checkRequiredArgument(t,"Value for Property "+e,r),e){case"name":this.setName(t);break;case"hand":this.setHand(t);break;case"active":t?this.makeActive():this.makeInactive();break;default:Bridge._reportError("Unknown property "+e,r)}},Bridge.Hand.prototype.get=function(e){var t="In Hand.get";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"direction":return this.getDirection();case"name":return this.getName();case"id":return this.getID();case"count":return this.getCount();case"hand":return this.getHand();case"active":return this.isActive();default:Bridge._reportError("Unknown property "+e,t)}},Bridge.Hand.prototype.toString=function(){var e="";return _.each(Bridge.suitOrder,function(t){var r="";_.each(Bridge.rankOrder,function(e){this.cards[t][e]&&(r+=this.showAsX[t][e]?"x":e)},this),r&&(e+=t+r)},this),e},Bridge.Hand.prototype.fromString=function(e){Bridge._checkRequiredArgument(e),this.clearCards();var t={};for(var r in Bridge.directions)t[r]=!1;e=e.toLowerCase();for(var i="",n="",a=0;a<e.length;++a){var o="In hand for "+this.direction+" at position "+(a+1),s=e.charAt(a);switch(s){case"c":case"d":case"h":case"s":i=s,t[i]&&Bridge._reportError(" suit "+i+" has already been seen before!",o),t[i]=!0;break;case"1":if(""===i&&Bridge._reportError(s+" was found when a suit was expected!",o),!(a<e.length-1&&"0"===e.charAt(a+1))){Bridge._reportError("a 1 is present without a subsequent 0. Use 10 or t to reprensent the ten.",o);continue}n="t",a++,this.addCard(i,n);break;default:if(""===i){Bridge._reportError(s+" was found when a suit was expected!",o);continue}n=s,this.addCard(i,n)}}this.onChange("setHand",e)},Bridge.Hand.prototype.hasCards=function(e){return this.numCards[e]>0},Bridge.Hand.prototype.getRanks=function(e){return this.getCount(e)<=0?[{rank:"-",html:"- "}]:(out=[],_.each(Bridge.rankOrder,function(t){if(this.cards[e][t]){var r=this.showAsX[e][t]?"x":t,i=this.showAsX[e][t]?"x":Bridge.ranks[r].html;out.push({rank:r,html:i})}},this),out)},Bridge.Hand.prototype.getSuits=function(e){if(!e)return Bridge.suitOrder;var t=0,r={};return _.each(Bridge.suitOrder,function(e){this.hasCards(e)&&t++},this),t<3?Bridge.suitOrder:4===t?["s","h","c","d"]:r.s&&r.c?Bridge.suitOrder:["h","s","c","d"]},Bridge.Hand.prototype.toJSON=function(){var e={};return e.direction=this.direction,e.name=this.name,e.hand=this.getHand(),e},Bridge.Hand.prototype.fromJSON=function(e){Bridge._checkRequiredArgument(e),this.name=e.name,this.setHand(e.hand)},Bridge.Hand.prototype.onChanged=function(){if(this.respondToEvents){var e=Bridge.getEventName([this.getID(),Bridge.CONSTANTS.changeEventName,"hand",this.getDirection()]);$(document).on(e,{hand:this},function(e,t){e.data.hand[t.operation](t.parameters)})}},Bridge.Hand.prototype.onChange=function(e,t){Bridge._raiseEvents(this,e,t)};var Bridge=Bridge||{};Bridge.Call=function(e,t){Bridge._checkBid(e),Bridge._checkDirection(t),this.call=e,this.direction=t,this.annotation="",this.explanation=""},Bridge.Call.prototype.getCall=function(){return this.call},Bridge.Call.prototype.getLevel=function(){return 1===this.call.length?0:_.parseInt(this.call[0])},Bridge.Call.prototype.getSuit=function(){return 1===this.call.length?this.call[0]:this.call[1]},Bridge.Call.prototype.setDirection=function(e){Bridge._checkDirection(e),this.direction=e},Bridge.Call.prototype.getDirection=function(){return this.direction},Bridge.Call.prototype.getAnnotation=function(){return this.annotation},Bridge.Call.prototype.setAnnotation=function(e){Bridge._checkRequiredArgument(e),this.annotation=e},Bridge.Call.prototype.getExplanation=function(){return this.explanation},Bridge.Call.prototype.setExplanation=function(e){Bridge._checkRequiredArgument(e),this.explanation=e},Bridge.Call.prototype.set=function(e,t){var r="In Call.set";switch(Bridge._checkRequiredArgument(e,"Property",r),Bridge._checkRequiredArgument(t,"Value for Property "+e,r),e){case"direction":this.setDirection(t);break;case"annotation":this.setAnnotation(t);break;case"explanation":this.setExplanation(t);break;default:Bridge._reportError("Unknown property "+e,r)}},Bridge.Call.prototype.get=function(e){var t="In Call.get";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"call":return this.getCall();case"direction":return this.getDirection();case"annotation":return this.getAnnotation();case"explanation":return this.getExplanation();default:Bridge._reportError("Unknown property "+e,t)}},Bridge.Call.prototype.toString=function(){var e="";return e+=this.call,this.explanation&&(e+="("+this.explanation+")"),this.annotation&&(e+="{"+this.annotation+"}"),e};var Bridge=Bridge||{};Bridge.Auction=function(e){this.deal=e,this.parent=e,this.id=e?e.id:Bridge.IDManager.getID(),this.type="Auction",this.raiseEvents=!0,this.respondToEvents=!0,this.dealer=e?e.getDealer():"n",this.vulnerability=e?e.getVulnerability():"-",this.nextToCall=this.dealer,this.calls=[],this.contracts=[],this.selectedLevel=0,this.currentAuctionIndex=-1,this.onChanged()},Bridge.Auction.prototype.getNextToCall=function(){return this.nextToCall},Bridge.Auction.prototype.getDealer=function(){return this.dealer},Bridge.Auction.prototype.setDealer=function(e){_.isObject(e)&&(e=e.dealer),Bridge._checkDirection(e),this.dealer=e;var t=e;_.each(this.calls,function(e){e.setDirection(t),t=Bridge.getLHO(t)},this),this.nextToCall=t,this.onChange("setDealer",e)},Bridge.Auction.prototype.getVulnerability=function(){return this.vulnerability},Bridge.Auction.prototype.isVulnerable=function(e){var t=this.getVulnerability();return"b"===t||t===e||t===Bridge.getPartner(e)},Bridge.Auction.prototype.setVulnerability=function(e){_.isObject(e)&&(e=e.vulnerability),Bridge._checkVulnerability(e),this.vulnerability=e,this.onChange("setVulnerability",e)},Bridge.Auction.prototype.getSelectedLevel=function(){return this.selectedLevel},Bridge.Auction.prototype.setSelectedLevel=function(e){_.isObject(e)&&(e=e.level),Bridge._checkLevel(e),this.selectedLevel=e,this.onChange("setSelectedLevel",e)},Bridge.Auction.prototype.unsetSelectedLevel=function(){this.selectedLevel=null,this.onChange("setSelectedLevel",this.selectedLevel)},Bridge.Auction.prototype.setAuction=function(e){_.isObject(e)&&(e=e.auction),Bridge._checkRequiredArgument(e),this.fromString(e),this.onChange("setAuction",e)},Bridge.Auction.prototype.getAuction=function(){return this.toString()},Bridge.Auction.prototype.getDirectionOrder=function(e){e=e||"w",directions=[],direction=e;for(var t=0;t<4;++t)directions.push(direction),direction=Bridge.getLHO(direction);return directions},Bridge.Auction.prototype.getCalls=function(e,t){for(e=e||"w",t=t||!1,calls=[],direction=e;this.dealer!==direction;)calls.push("-"),direction=Bridge.getLHO(direction);for(calls=calls.concat(this.calls),!this.getContract().isComplete&&t&&calls.push("?");calls.length%4!==0;)calls.push("");return _.chunk(calls,4)},Bridge.Auction.prototype.setContract=function(e){_.isObject(e)&&(e=e.contract),Bridge._checkRequiredArgument(e);var t="In Bridge.setContract",r=0;e.length<r+1&&Bridge._reportError("Contract string "+e+" does not specify level!",t);var i=_.parseInt(e[r++]);e.length<r+1&&Bridge._reportError("Contract string "+e+" does not specify suit!",t);var n=e[r++].toLowerCase();Bridge._checkBid(i+n,t),Bridge.isStrain(n)||Bridge._reportError("Contract string "+e+" does not specify a valid suit!",t);var a=!1,o=!1;e.length>r&&"x"===e[r].toLowerCase()&&(a=!0,r++,e.length>r&&"x"===e[r].toLowerCase()&&(o=!0,r++)),e.length<r+1&&Bridge._reportError("Contract string "+e+" does not specify declarer!",t);var s=e[r].toLowerCase();for(Bridge._checkDirection(s),this.clearCalls();this.nextToCall!==s;)this.addCall("p");this.addCall(i+n),a&&this.addCall("x"),o&&this.addCall("r"),this.addCall("p"),this.addCall("p"),this.addCall("p"),this.onChange("setContract",e),this.onChange("setAuction",this.getAuction())},Bridge.Auction.prototype.getContract=function(){var e=this.calls.length;return 0===e?new Bridge.Contract:this.contracts[e-1]},Bridge.Auction.prototype.getID=function(){return this.id},Bridge.Auction.prototype.get=function(e){var t="In Auction.get";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"dealer":return this.getDealer();case"vulnerability":return this.getVulnerability();case"level":return this.getSelectedLevel();case"contract":return this.getContract();case"auction":return this.getAuction();case"id":return this.getID();default:Bridge._reportError("Unknown deal property "+e,t)}},Bridge.Auction.prototype.set=function(e,t){var r="In Auction.set";switch(Bridge._checkRequiredArgument(e,"Property",r),Bridge._checkRequiredArgument(t,"Value for Property "+e,r),e){case"dealer":this.setDealer(t);break;case"vulnerability":this.setVulnerability(t);break;case"level":this.setSelectedLevel(t);case"contract":this.setContract(t);break;case"auction":this.setAuction(t);break;default:Bridge._reportError("Unknown deal property "+e,r)}},Bridge.Auction.prototype.addCall=function(e,t,r){_.isObject(e)&&(t=e.explanation,r=e.annotation,e=e.call);var i="In Auction.addCall";e=e.toLowerCase(),Bridge._checkBid(e,i);var e=new Bridge.Call(e,this.nextToCall);if(r&&e.setAnnotation(r),t&&e.setExplanation(t),0===this.calls.length)var n=new Bridge.Contract;else var n=this.getContract().clone();n.update(e),this.calls.push(e),this.contracts.push(n),this.nextToCall=Bridge.getLHO(this.nextToCall),this.selectedLevel=0,this.onChange("addCall",{call:e,contract:this.getContract()}),this.getContract().isComplete&&this.onChange("auctionComplete",{call:e,contract:this.getContract()})},Bridge.Auction.prototype.addAllPass=function(){for(;!this.getContract().isComplete;)this.addCall("p")},Bridge.Auction.prototype.clearCalls=function(){for(;this.calls.length>0;)this.removeCall()},Bridge.Auction.prototype.abstain=function(){this.onChange("abstained",{})},Bridge.Auction.prototype.removeCall=function(){if(this.calls.length>0){var e=this.calls[this.calls.length-1];this.calls.pop(),this.contracts.pop(),this.nextToCall=Bridge.getRHO(this.nextToCall),this.selectedLevel=0,this.onChange("removeCall",e.getCall())}},Bridge.Auction.prototype.advanceAuctionTillIndex_=function(e){
var t="In Bridge.Auction.advanceAuctionTillIndex_";for((e<0||e>=this.calls.length)&&Bridge._reportError("Cannot advance because specified call number "+e+" is invalid",t),this.currentAuctionIndex>=e&&Bridge._reportError("Cannot advance because current call number is at or greater than specified call number "+e,t);this.currentAuctionIndex<e;){this.currentAuctionIndex++;var r=this.calls[this.currentAuctionIndex];this.onChange("advanceAuction",r)}this.onChange("advanceAuctionCompleted",r)},Bridge.Auction.prototype.advanceAuction=function(){this.advanceAuctionTillIndex_(this.currentAuctionIndex+1)},Bridge.Auction.prototype.advanceAuctionAll=function(){var e=this.calls.length-1;this.advanceAuctionTillIndex_(e)},Bridge.Auction.prototype.rewindAuctionTillIndex_=function(e){var t="In Bridge.Auction.rewindAuctionTillIndex_";for((e<-1||e>=this.calls.length-1)&&Bridge._reportError("Cannot rewind because specified call number "+e+" is invalid",t),this.currentAuctionIndex<=e&&Bridge._reportError("Cannot rewind because current call number is at or lesser than specified call number "+e,t);this.currentAuctionIndex>e;){var r=this.calls[this.currentAuctionIndex];this.currentAuctionIndex--,this.onChange("rewindAuction",r)}this.onChange("rewindAuctionCompleted",r)},Bridge.Auction.prototype.rewindAuction=function(){this.rewindAuctionTillIndex_(this.currentAuctionIndex-1)},Bridge.Auction.prototype.rewindAuctionAll=function(){var e=-1;this.rewindAuctionTillIndex_(e)},Bridge.Auction.prototype.rewind=Bridge.Auction.prototype.rewindAuctionAll,Bridge.Auction.prototype.fromString=function(e){this.clearCalls();for(var t="In Auction.fromString",r=0;r<e.length;){var i=e[r++].toLowerCase();if("d"===i&&(i="x"),_.has(Bridge.calls,i)&&!Bridge.isStrain(i))var n=i;else var n=i+e[r++].toLowerCase();for(var a=null,o=null;r<e.length&&("("===e[r]||"{"===e[r]);){if("("===e[r]){var s=")",d=Bridge._parseContainedText(e,r,s,t);a=d.text}else{var s="}",d=Bridge._parseContainedText(e,r,s,t);o=d.text}r=d.position+1}this.addCall(n,a,o)}},Bridge.Auction.prototype.fromJSON=function(e){return this.fromString(e)},Bridge.Auction.prototype.toString=function(){for(var e="",t=0;t<this.calls.length;++t)e+=this.calls[t].toString();return e},Bridge.Auction.prototype.toJSON=function(){return this.toString()},Bridge.Auction.prototype.onChanged=function(){if(this.respondToEvents){var e=Bridge.getEventName([this.getID(),Bridge.CONSTANTS.changeEventName,"auction"]);$(document).on(e,{auction:this},function(e,t){e.data.auction[t.operation](t.parameters)})}},Bridge.Auction.prototype.onChange=function(e,t){Bridge._raiseEvents(this,e,t)};var Bridge=Bridge||{};Bridge.Contract=function(){this.level=null,this.suit=null,this.doubled=!1,this.redoubled=!1,this.declarer=null,this.firstToBid={};for(var e in Bridge.calls)if(Bridge.isStrain(e)){this.firstToBid[e]={};for(var t in Bridge.directions)this.firstToBid[e][t]=null}this.numPasses=0,this.isComplete=!1},Bridge.Contract.prototype.getSuit=function(){return this.suit},Bridge.Contract.prototype.getDeclarer=function(){return this.declarer},Bridge.Contract.prototype.getLeader=function(){return Bridge.getLHO(this.declarer)},Bridge.Contract.prototype.allowedCalls=function(e){Bridge._checkDirection(e);var t={};t.p=!this.isComplete,t.ap=t.p,t.x=!1,t.r=!1;for(var r=1;r<=7;++r)for(var i in Bridge.calls)Bridge.isStrain(i)&&(t[r+i]=!this.isComplete);if(t.u=!(null===this.suit&&0===this.numPasses),t.minimum_level=8,null===this.suit||this.isComplete)return this.isComplete||(t.minimum_level=1),t;for(var r=1;r<=7;++r)for(var i in Bridge.calls)Bridge.isStrain(i)&&(r>this.level||r===this.level&&Bridge.calls[i].index<Bridge.calls[this.suit].index?(t[r+i]=!0,r<t.minimum_level&&(t.minimum_level=r)):t[r+i]=!1);return t.p=!0,t.x=!this.doubled&&!this.redoubled&&Bridge.areOpponents(e,this.declarer),t.r=this.doubled&&!this.redoubled&&!Bridge.areOpponents(e,this.declarer),t},Bridge.Contract.prototype.clone=function(){var e=new Bridge.Contract,t=["level","suit","doubled","redoubled","declarer","numPasses","isComplete"];return _.each(t,function(t){e[t]=this[t]},this),e.firstToBid=_.cloneDeep(this.firstToBid),e},Bridge.Contract.prototype.update=function(e){this.isComplete&&Bridge._reportError("Auction is already complete. Cannot make another call");var t=e.getLevel(),r=e.getSuit(),i=e.getDirection();switch(r){case"p":this.numPasses++,(this.declarer&&3===this.numPasses||4===this.numPasses)&&(this.isComplete=!0);break;case"x":this.declarer&&Bridge.areOpponents(this.declarer,i)&&!this.redoubled&&!this.doubled||Bridge._reportError("Double is not allowed at this point in the auction"),this.doubled=!0,this.numPasses=0;break;case"r":(!this.doubled||Bridge.areOpponents(this.declarer,i)||this.redoubled)&&Bridge._reportError("ReDouble is not allowed at this point in the auction"),this.redoubled=!0,this.numPasses=0;break;default:(t<this.level||t===this.level&&Bridge.calls[r].index>=Bridge.calls[this.suit].index)&&Bridge._reportError(e.toString()+" is not allowed at this point in the auction"),this.doubled=!1,this.redoubled=!1,this.numPasses=0,this.firstToBid[r][i]||(this.firstToBid[r][i]=i,this.firstToBid[r][Bridge.getPartner(i)]=i),this.declarer=this.firstToBid[r][i],this.suit=r,this.level=t}},Bridge.Contract.prototype.toString=function(){var e="";return this.level&&(e+=this.level,e+=this.suit,this.redoubled?e+="xx":this.doubled&&(e+="x"),e+=this.declarer),e};var Bridge=Bridge||{};Bridge.Play=function(e){this.deal=e,this.id=Bridge._generateID(e),this.type="Play",this.raiseEvents=!0,this.respondToEvents=!0,this.plays=[];for(var t=0;t<=52;++t)this.plays.push(null);this.lastPlayIndex=-1,this.currentPlayIndex=0,this.cardAdded={};for(var r in Bridge.suits){this.cardAdded[r]={};for(var i in Bridge.ranks)this.cardAdded[r][i]=!1}this.cardPlayed={};for(var r in Bridge.suits){this.cardPlayed[r]={};for(var i in Bridge.ranks)this.cardPlayed[r][i]=!1}this.leader="w",this.trump="n",this.initialize()},Bridge.Play.prototype.setID=function(e){Bridge._checkRequiredArgument(e),this.id=e},Bridge.Play.prototype.getID=function(){return this.id},Bridge.Play.prototype.setTrump=function(e){Bridge._checkRequiredArgument(e),Bridge._checkStrain(e),this.trump=e,this.plays[0].setTrump(e)},Bridge.Play.prototype.getTrump=function(){return this.trump},Bridge.Play.prototype.setLeader=function(e){Bridge._checkRequiredArgument(e),Bridge._checkDirection(e),this.leader=e,this.plays[0].setLeader(e)},Bridge.Play.prototype.getLeader=function(){return this.leader},Bridge.Play.prototype.setPlay=function(e){Bridge._checkRequiredArgument(e),this.fromString(e)},Bridge.Play.prototype.getPlay=function(){return this.toString()},Bridge.Play.prototype.get=function(e){var t="In Play.get";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"id":return this.getID();case"trump":return this.getTrump();case"leader":return this.getLeader();case"play":return this.getPlay();default:Bridge._reportError("Unknown deal property "+e,t)}},Bridge.Play.prototype.set=function(e,t){var r="In Play.set";switch(Bridge._checkRequiredArgument(e,"Property",r),Bridge._checkRequiredArgument(t,"Value for Property "+e,r),e){case"id":this.setID(t);break;case"trump":this.setTrump(t);break;case"leader":this.setLeader(t);case"play":this.setPlay(t);break;default:Bridge._reportError("Unknown deal property "+e,r)}},Bridge.Play.prototype.initialize=function(){var e="Bridge.Play initialize";if(this.deal&&this.deal.getAuction().getContract().isComplete){var t=this.deal.getAuction().getContract();t.isComplete||Bridge._reportError("Cannot initialize play unless auction is complete",e),this.trump=t.getSuit(),this.leader=t.getLeader()}this.plays[0]=new Bridge.PlayedCard(0,this.trump,this.leader),this.lastPlayIndex=0},Bridge.Play.prototype.getNextToPlay=function(){var e="Bridge.Play getNextToPlay";return this.lastPlayIndex===-1&&Bridge._reportError("No play entries have been added. Cannot get next to play",e),this.plays[this.lastPlayIndex].getNextToPlay()},Bridge.Play.prototype.addCard=function(e,t,r){var i="In Bridge.Play.addCard";e=e.toLowerCase(),t=t.toLowerCase(),Bridge._checkSuit(e,i),Bridge._checkRank(t,i);var n=this.deal?this.deal.cards[e][t]:new Bridge.Card(e,t),a=this.getNextToPlay();this.deal&&!this.deal.getHand(a).hasCard(e,t)&&Bridge._reportError(e+t+" does not belong to "+a,i),this.cardAdded[e][t]&&Bridge._reportError(e+t+" is already part of play",i);var o=this.lastPlayIndex+1,s=this.plays[this.lastPlayIndex],d=new Bridge.PlayedCard(o,n,s,r);this.plays[this.lastPlayIndex+1]=d,this.lastPlayIndex++,this.cardAdded[e][t]=!0,this.onChange("addCard",d)},Bridge.Play.prototype.removeCard=function(){var e="In Bridge.Play.removeCard";if(this.lastPlayIndex>0){var t=this.plays[this.lastPlayIndex];this.plays[this.lastPlayIndex]=null,this.lastPlayIndex--,this.currentPlayIndex>this.lastPlayIndex&&(this.currentPlayIndex=this.lastPlayIndex),this.cardAdded[t.getSuit()][t.getRank()]=!1,this.onChange("removeCard",t)}else Bridge._reportError("No more plays to remove",e)},Bridge.Play.prototype.playCardTillIndex_=function(e){var t="In Bridge.Play.playCardTillIndex_";for((e<1||e>this.lastPlayIndex)&&Bridge._reportError("Cannot advance because specified play number "+e+" is invalid",t),this.currentPlayIndex>=e&&Bridge._reportError("Cannot advance because current play number is at or greater than specified play number "+e,t);this.currentPlayIndex<e;){this.currentPlayIndex++;var r=this.plays[this.currentPlayIndex];this.cardPlayed[play.getSuit()][play.getRank()]=!0,this.onChange("playCard",r)}this.onChange("playCardCompleted",r)},Bridge.Play.prototype.playCard=function(){this.playCardTillIndex_(this.currentPlayIndex+1)},Bridge.Play.prototype.playTrick=function(){for(var e=this.currentPlayIndex+1;e%4!==0;)e++;this.playCardTillIndex_(e)},Bridge.Play.prototype.playAll=function(){var e=this.lastPlayIndex;this.playCardTillIndex_(e)},Bridge.Play.prototype.undoPlayCardTillIndex_=function(e){var t="In Bridge.Play.unplayCardTillIndex_";for((e<0||e>=this.lastPlayIndex)&&Bridge._reportError("Cannot rewind because specified play number "+e+" is invalid",t),this.currentPlayIndex<=e&&Bridge._reportError("Cannot rewind because current play number is at or lesser than specified play number "+e,t);this.currentPlayIndex>e;){var r=this.plays[this.currentPlayIndex];this.currentPlayIndex--,this.cardPlayed[play.getSuit()][play.getRank()]=!1,this.onChange("undoPlayCard",r)}this.onChange("undoPlayCardCompleted",r)},Bridge.Play.prototype.undoPlayCard=function(){this.undoPlayCardTillIndex_(this.currentPlayIndex-1)},Bridge.Play.prototype.undoPlayTrick=function(){for(var e=this.currentPlayIndex-1;e%4!==0;)e--;this.undoPlayCardTillIndex_(e)},Bridge.Play.prototype.undoPlayAll=function(){var e=0;this.undoPlayCardTillIndex_(e)},Bridge.Play.prototype.rewind=Bridge.Play.prototype.undoPlayAll,Bridge.Play.prototype.clearCards=function(){for(;this.lastPlayIndex>0;)this.removeCard()},Bridge.Play.prototype.fromString=function(e){this.clearCards();for(var t="In Play.fromString",r=0;r<e.length;){var i=e[r++].toLowerCase();r>=e.length&&Bridge._reportError("Play ends unexpectedly on suit with no rank",t);var n=e[r++].toLowerCase(),a=null;if("{"===e[r]){var o="}",s=Bridge._parseContainedText(e,r,o,t);a=s.text,r=s.position+1}this.addCard(i,n,a)}},Bridge.Play.prototype.fromJSON=function(e){return this.fromString(e)},Bridge.Play.prototype.toString=function(){for(var e="",t=1;t<=this.lastPlayIndex;++t)e+=this.plays[t].toString();return e},Bridge.Play.prototype.toJSON=function(){return this.toString()},Bridge.Play.prototype.onChange=function(e,t){Bridge._raiseEvents(this,e,t)};var Bridge=Bridge||{};Bridge.PlayedCard=function(e,t,r,i){var n="In Bridge.PlayedCard constructor",a=_.parseInt(e);return(_.isNaN(a)||a<0||a>52)&&Bridge._reportError("Playnumber : "+e+" is not valid!",n),a>0&&a!==r.getPlayNumber()+1&&Bridge._reportError("Playnumber : "+e+" does not follow previous playNumber :"+r.getPlayNumber()+"!",n),this.playNumber=a,this.nextToPlay=null,this.winningCard=null,this.leadCard=null,this.annotation=i,0===a?(Bridge._checkStrain(t),this.trump=t,Bridge._checkDirection(r),this.leader=r,this.nextToPlay=this.leader,this.direction=null,this.nsTricks=0,this.ewTricks=0,void this.clearTableCards_()):(this.tableCards=_.clone(r.tableCards),this.nsTricks=r.getNSTricks(),this.ewTricks=r.getEWTricks(),t instanceof Bridge.Card&&r instanceof Bridge.PlayedCard||Bridge._reportError("Invalid card or previousCard!",n),this.card=t,this.previousCard=r,this.trump=this.previousCard.trump,this.leader=this.previousCard.leader,this.direction=this.previousCard.nextToPlay,void this.updateInformation_())},Bridge.PlayedCard.prototype.getCard=function(){return this.card},Bridge.PlayedCard.prototype.getPlayNumber=function(){return this.playNumber},Bridge.PlayedCard.prototype.getTrump=function(){return this.trump},Bridge.PlayedCard.prototype.setTrump=function(e){var t="In PlayedCard.setTrump";Bridge._checkRequiredArgument(e),Bridge._checkStrain(e),0!==this.getPlayNumber()&&Bridge._reportError("Cannot update trump for Playnumber : "+this.getPlayNumber()+" ",t),this.trump=e},Bridge.PlayedCard.prototype.getLeader=function(){return this.leader},Bridge.PlayedCard.prototype.setLeader=function(e){var t="In PlayedCard.setLeader";Bridge._checkRequiredArgument(e),Bridge._checkDirection(e),0!==this.getPlayNumber()&&Bridge._reportError("Cannot update leader for Playnumber : "+this.getPlayNumber()+" ",t),this.leader=e,this.nextToPlay=e},Bridge.PlayedCard.prototype.getSuit=function(){return this.card.getSuit()},Bridge.PlayedCard.prototype.getRank=function(){return this.card.getRank()},Bridge.PlayedCard.prototype.getDirection=function(){return this.direction},Bridge.PlayedCard.prototype.getNextToPlay=function(){return this.nextToPlay},Bridge.PlayedCard.prototype.getWinningCard=function(){return this.winningCard},Bridge.PlayedCard.prototype.getLeadCard=function(){return this.leadCard},Bridge.PlayedCard.prototype.getNSTricks=function(){return this.nsTricks},Bridge.PlayedCard.prototype.getEWTricks=function(){return this.ewTricks},Bridge.PlayedCard.prototype.clearTableCards_=function(){this.tableCards={};for(var e in Bridge.directions)this.tableCards[e]=null},Bridge.PlayedCard.prototype.get=function(e){var t="In Call.get";switch(Bridge._checkRequiredArgument(e,"Property",t),e){case"play_number":return this.getPlayNumber();case"trump":return this.getTrump();case"leader":return this.getLeader();case"card":return this.getCard();case"suit":return this.getSuit();case"rank":return this.getRank();case"direction":return this.getDirection();case"winning_card":return this.getWinningCard();case"lead_card":return this.getLeadCard();case"ns_tricks":return this.getNSTricks();case"ew_tricks":return this.getEWTricks();case"next_to_play":return this.getNextToPlay();default:Bridge._reportError("Unknown property "+e,t)}},Bridge.PlayedCard.prototype.updateInformation_=function(){if(this.nextToPlay=this.previousCard?Bridge.getLHO(this.getDirection()):Bridge.getLHO(this.leader),this.playNumber%4===1&&this.clearTableCards_(),this.tableCards[this.direction]=this.card,this.playNumber%4===1)return this.winningCard=this,void(this.leadCard=this);var e=this.previousCard.winningCard;this.leadCard=e.getLeadCard();var t=e.getSuit(),r=e.getRank(),i=this.getSuit(),n=this.getRank(),a=this.trump;if(t===a?i===a&&Bridge.isHigherRank(n,r)?this.winningCard=this:this.winningCard=e:i===a||i===t&&Bridge.isHigherRank(n,r)?this.winningCard=this:this.winningCard=e,this.playNumber%4===0){var o=this.winningCard.getDirection();Bridge.isNorthSouth(o)?this.nsTricks++:this.ewTricks++,this.nextToPlay=o}},Bridge.PlayedCard.prototype.toString=function(){var e="";return e+=this.card.toString(),this.annotation&&(e+="{"+this.annotation+"}"),e};var templateRegistry=function(){var e={},t={declareTemplate:function(t,r){e[t]=_.template(r)},renderTemplate:function(t,r){return e.hasOwnProperty(t)?e[t](r):"No template with name "+t+" was found!"}};return t}();_.mixin(templateRegistry);var Bridge=Bridge||{};Bridge.Hand.registerTemplate=function(e,t){_.declareTemplate("hand."+e,t)},Bridge._addWrapper=function(e,t){return e.wrapperID?t:(e.wrapperID=Bridge.IDManager.getID(),e.wrapperClass=e.wrapperClass||"standard","<section id='"+e.wrapperID+"' class='"+e.wrapperClass+"'>"+t+"</section>")},Bridge._registerClickHandler=function(e,t,r){if(t.handlers&&t.handlers.click){var i="#"+t.wrapperID+" [data-enabled]";$(i).one("click",{owner:e},function(t){var i=Bridge.getEventName([e.getID(),Bridge.CONSTANTS.changeEventName,r]),n=$(this).data("operation");n&&$(document).trigger(i,{operation:n,parameters:$(this).data()})})}},Bridge._registerChangeHandler=function(e,t,r){if(t.handlers&&t.handlers.change){var i=Bridge.getEventName([e.getID(),Bridge.CONSTANTS.changedEventName])+"."+t.wrapperID;$(document).one(i,{config:t,owner:e,callback:r},function(e,t){var r=e.data.config.wrapperID;0!==$("#"+r).length&&e.data.owner[e.data.callback](e.data.config)})}},Bridge._wrapAndEmbedHTML=function(e,t){return t.wrapperID?$("#"+t.wrapperID).empty().append(e):(e=Bridge._addWrapper(t,e),t.containerID&&$("#"+t.containerID).empty().append(e)),e},Bridge._cloneConfig=function(e){return e?_.cloneDeep(e):{}},Bridge.Hand.prototype.showHand=function(e){e=Bridge._cloneConfig(e),e.template=e.template||"standard";var t="hand."+e.template,r=_.renderTemplate(t,{hand:this,config:e});return Bridge._wrapAndEmbedHTML(r,e),Bridge._registerChangeHandler(this,e,"toHTML"),r},Bridge.Hand.prototype.toHTML=Bridge.Hand.prototype.showHand,Bridge.Auction.prototype.showAuction=function(e){e=Bridge._cloneConfig(e),e.template=e.template||"standard";var t="auction."+e.template,r=_.renderTemplate(t,{auction:this,config:e});return Bridge._wrapAndEmbedHTML(r,e),Bridge._registerChangeHandler(this,e,"toHTML"),r},Bridge.Auction.prototype.toHTML=Bridge.Auction.prototype.showAuction,Bridge.Auction.prototype.showBiddingBox=function(e){e=Bridge._cloneConfig(e),e.template=e.template||"standard";var t="auction.bidding-box."+e.template,r=_.renderTemplate(t,{auction:this,config:e});return Bridge._wrapAndEmbedHTML(r,e),Bridge._registerChangeHandler(this,e,"showBiddingBox"),Bridge._registerClickHandler(this,e,"auction"),r},Bridge.Deal.prototype.showCardDeck=function(e){e=Bridge._cloneConfig(e),e.template=e.template||"standard";var t="deal.card-deck."+e.template,r=_.renderTemplate(t,{deal:this,config:e});return Bridge._wrapAndEmbedHTML(r,e),Bridge._registerChangeHandler(this,e,"showCardDeck"),Bridge._registerClickHandler(this,e,"deal"),r},Bridge.Deal.prototype.showDeal=function(e){e=Bridge._cloneConfig(e),e.template=e.template||"standard";var t="deal."+e.template,r=_.renderTemplate(t,{deal:this,config:e});return Bridge._wrapAndEmbedHTML(r,e),Bridge._registerChangeHandler(this,e,"showDeal"),Bridge._registerClickHandler(this,e,"deal"),r},Bridge.Deal.prototype.toHTML=Bridge.Deal.prototype.showDeal;